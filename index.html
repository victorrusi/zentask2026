<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ZenTask Pro 2026</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#5c67f2">
  <link rel="manifest" href="manifest.json">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root { --p: #5c67f2; --bg: #f4f7fe; --d: #ef4444; --pdf: #10b981; --dark: #1e293b; --a: #ff9f43; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; -webkit-tap-highlight-color: transparent; }
    #login-screen { position: fixed; inset: 0; background: var(--p); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
    #login-screen input { padding: 12px; border-radius: 8px; border: none; width: 220px; margin-bottom: 10px; text-align: center; font-size: 16px; }
    #app-content { display: none; }
    .controls { position: sticky; top: 0; z-index: 100; background: white; padding: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
    .nav-buttons { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; margin-top: 5px; }
    .nav-buttons button { padding: 8px 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.7rem; background: #e2e8f0; color: #1e293b; }
    .nav-buttons button.active { background: var(--p); color: white; }
    .month-selector { display: none; justify-content: center; gap: 3px; margin-top: 10px; flex-wrap: wrap; }
    .year-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; padding: 12px; }
    .day-card { background: white; border-radius: 12px; padding: 12px; border-top: 4px solid var(--p); display: flex; flex-direction: column; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .hidden { display: none !important; }
    .day-total { font-size: 0.7rem; background: var(--a); color: white; padding: 2px 6px; border-radius: 10px; font-weight: bold; }
    .task-item { padding: 6px 10px; margin-bottom: 5px; border-radius: 8px; display: flex; align-items: center; font-size: 0.8rem; }
    .edit-time { width: 35px; padding: 2px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.75rem; margin: 0 5px; text-align: center; }
    .add-area { border-top: 1px solid #eee; padding-top: 8px; margin-top: auto; display: flex; flex-direction: column; gap: 5px; }
  </style>
</head>
<body>
<div id="login-screen">
  <h1 style="margin-bottom:20px;">ZenTask Pro</h1>
  <input type="text" id="user-in" placeholder="Tu nombre..." autocomplete="off">
  <button onclick="login()" style="padding:12px 25px; cursor:pointer; background:var(--dark); color:white; border:none; border-radius:8px; font-weight:bold;">ENTRAR</button>
</div>
<div id="app-content">
  <div class="controls">
    <h3 style="margin:0; color:var(--p);">ZenTask @<span id="disp-user"></span></h3>
    <div class="nav-buttons">
      <button onclick="filtrarSemana(this)" id="btn-default">SEMANA</button>
      <button onclick="toggleMeses(this)">MES</button>
      <button onclick="filtrarTodo(this)">AÑO</button>
      <button onclick="exportarPDF()" style="background:var(--pdf); color:white;">PDF</button>
      <button onclick="borrarTodo()" style="background:var(--d); color:white;">BORRAR AÑO</button>
      <button onclick="location.reload()" style="background:var(--dark); color:white;">SALIR</button>
      <button onclick="subscribePush()" style="background:var(--p);color:white;border:none;border-radius:6px;padding:10px;">
        Activar recordatorios
      </button>
    </div>
    <div id="month-nav" class="month-selector"></div>
  </div>
  <div id="calendario" class="year-grid"></div>
</div>

<script>
  let currentUser = "";

  function login() {
    const input = document.getElementById("user-in").value.trim();
    if (input.length === 0) {
      alert("Por favor, escribe un nombre de usuario");
      return;
    }
    currentUser = input;
    document.getElementById("disp-user").textContent = currentUser;
    document.getElementById("login-screen").style.display = "none";
    document.getElementById("app-content").style.display = "block";
    if (typeof load === "function") load();
  }

  // Registro del Service Worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js")
      .then(() => console.log("Service Worker registrado"))
      .catch(err => console.error("Error SW:", err));
  }

  // Suscripción a notificaciones push
  async function subscribePush() {
    const reg = await navigator.serviceWorker.ready;
    const subscription = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: "<TU_VAPID_PUBLIC_KEY>"
    });
    await fetch("https://TU-PROJECT.supabase.co/rest/v1/subscriptions", {
      method: "POST",
      headers: {
        "apikey": "<TU_API_KEY>",
        "Authorization": "Bearer <TU_API_KEY>",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        user: currentUser,
        subscription
      })
    });
    alert("✅ Suscripción guardada en Supabase");
  }

  // Aquí mantenés tus funciones originales:
  // load(), filtrarSemana(), toggleMeses(), filtrarTodo(), exportarPDF(), borrarTodo()
</script>
</body>
</html>
