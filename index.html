<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RuViGesTASK 2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#5c67f2">
    
    <script>
        const myManifest = {
            "name": "RuViGesTASK",
            "short_name": "RuViGesTASK",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f4f7fe",
            "theme_color": "#5c67f2",
            "icons": [{"src": "https://cdn-icons-png.flaticon.com/512/906/906334.png","sizes": "512x512","type": "image/png"}]
        };
        const blob = new Blob([JSON.stringify(myManifest)], {type: 'application/json'});
        document.querySelector('head').innerHTML += `<link rel="manifest" href="${URL.createObjectURL(blob)}">`;
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --p: #5c67f2; --bg: #f4f7fe; --d: #ef4444; --pdf: #10b981; --dark: #1e293b; --a: #ff9f43; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; -webkit-tap-highlight-color: transparent; }
        #login-screen { position: fixed; inset: 0; background: var(--p); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #login-screen input { padding: 12px; border-radius: 8px; border: none; width: 220px; margin-bottom: 10px; text-align: center; font-size: 16px; outline: none; }
        #app-content { display: none; }
        .controls { position: sticky; top: 0; z-index: 100; background: white; padding: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .nav-buttons { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; margin-top: 5px; }
        .nav-buttons button { padding: 8px 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.7rem; background: #e2e8f0; color: #1e293b; }
        .nav-buttons button.active { background: var(--p); color: white; }
        .month-selector { display: none; justify-content: center; gap: 3px; margin-top: 10px; flex-wrap: wrap; }
        .year-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; padding: 12px; }
        .day-card { background: white; border-radius: 12px; padding: 12px; border-top: 4px solid var(--p); display: flex; flex-direction: column; min-height: 320px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        .day-total { font-size: 0.7rem; background: var(--a); color: white; padding: 2px 6px; border-radius: 10px; font-weight: bold; }
        .task-list { margin: 10px 0; flex-grow: 1; }
        .task-item { padding: 8px 10px; margin-bottom: 6px; border-radius: 10px; display: flex; align-items: center; font-size: 0.85rem; border-left: 4px solid rgba(0,0,0,0.2); }
        .task-time-label { font-size: 0.75rem; font-weight: bold; background: rgba(255,255,255,0.6); padding: 2px 5px; border-radius: 5px; margin-right: 8px; display: flex; align-items: center; gap: 3px; }
        .edit-time { width: 38px; padding: 2px; border: 1px solid #ccc; border-radius: 5px; font-size: 0.75rem; text-align: center; font-weight: bold; }
        .add-area { border-top: 1px solid #eee; padding-top: 10px; margin-top: auto; display: flex; flex-direction: column; gap: 6px; }
        .input-row { display: flex; gap: 4px; align-items: center; }
        input[type="time"], input[type="number"], input[type="text"] { border: 1px solid #ddd; border-radius: 6px; padding: 8px; font-size: 16px; }
        #notif-status { font-size: 0.6rem; color: var(--d); margin-top: 5px; display: none; }
    </style>
</head>
<body onclick="activarAudio()">

<div id="login-screen">
    <h1 style="margin-bottom:10px;">RuViGesTASK</h1>
    <p style="font-size: 0.8rem; opacity: 0.8; margin-bottom: 20px;">Gesti√≥n de Tareas Avanzada</p>
    <input type="text" id="user-in" placeholder="Tu nombre..." autocomplete="off">
    <button onclick="login()" style="padding:14px 30px; cursor:pointer; background:var(--dark); color:white; border:none; border-radius:10px; font-weight:bold; font-size: 1rem;">ENTRAR</button>
</div>

<div id="app-content">
    <div class="controls">
        <h3 style="margin:0; color:var(--p);">RuViGesTASK @<span id="disp-user"></span></h3>
        <div id="notif-status">‚ö†Ô∏è Notificaciones desactivadas</div>
        <div class="nav-buttons">
            <button onclick="filtrarSemana(this)" id="btn-default">SEMANA</button>
            <button onclick="toggleMeses(this)">MES</button>
            <button onclick="filtrarTodo(this)">A√ëO</button>
            <button onclick="exportarPDF()" style="background:var(--pdf); color:white;">PDF</button>
            <button onclick="borrarTodo()" style="background:var(--d); color:white;">BORRAR A√ëO</button>
            <button onclick="location.reload()" style="background:var(--dark); color:white;">SALIR</button>
        </div>
        <div id="month-nav" class="month-selector"></div>
    </div>
    <div id="calendario" class="year-grid"></div>
</div>

<script>
    const URL = "https://odpeozxpgthiqhzktpaq.supabase.co/rest/v1/tasks";
    const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kcGVvenhwZ3RoaXFoemt0cGFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjAxNzYsImV4cCI6MjA4NDMzNjE3Nn0.pdcQJGZ8FcNUn77JrOrNWkPJp-_ink9zIjkPwsbu-9U";
    let currentUser = "";
    const headers = { 'apikey': KEY, 'Authorization': `Bearer ${KEY}`, 'Content-Type': 'application/json' };
    let tareasCargadas = [];
    let audioCtx = null;
    let ultimaAlarma = "";

    function activarAudio() { 
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); 
        if ("Notification" in window) {
            Notification.requestPermission().then(permission => {
                if(permission !== "granted") document.getElementById('notif-status').style.display = 'block';
                else document.getElementById('notif-status').style.display = 'none';
            });
        }
    }

    function beep() {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.type = "sine"; osc.frequency.value = 880; 
        gain.gain.setValueAtTime(0, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.1);
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.5);
        osc.stop(audioCtx.currentTime + 1.5);
    }

    function login() {
        const val = document.getElementById('user-in').value.trim();
        if(val) {
            currentUser = val.toLowerCase();
            document.getElementById('disp-user').innerText = val.toUpperCase();
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            init();
            // Revisamos cada 15 segundos para no fallar ni un minuto
            setInterval(checkAlarms, 15000);
        }
    }

    function init() {
        const grid = document.getElementById('calendario');
        const mNav = document.getElementById('month-nav');
        grid.innerHTML = ""; mNav.innerHTML = "";
        const meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
        meses.forEach((m, i) => {
            const btn = document.createElement('button');
            btn.innerText = m; btn.onclick = () => { filtrarMes(i); };
            mNav.appendChild(btn);
        });

        let f = new Date("2026-01-01T00:00:00");
        while(f.getFullYear() === 2026) {
            const iso = f.toLocaleDateString('sv-SE');
            const d = document.createElement('div');
            d.className = 'day-card'; d.dataset.date = iso; d.dataset.mes = f.getMonth();
            d.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <b style="font-size:0.8rem;">${f.toLocaleDateString('es-ES',{weekday:'short',day:'numeric',month:'short'}).toUpperCase()}</b>
                    <div style="display:flex;align-items:center;gap:5px;">
                        <span id="t-${iso}" class="day-total">0 min</span>
                        <button onclick="borrarDia('${iso}')" style="border:none;background:none;color:red;cursor:pointer;font-size:1.1rem;">üóëÔ∏è</button>
                    </div>
                </div>
                <div id="l-${iso}" class="task-list"></div>
                <div class="add-area">
                    <input id="i-${iso}" placeholder="Tarea..." style="width:92%;">
                    <div class="input-row">
                        <input type="time" id="h-${iso}" style="flex:1;">
                        <input type="number" id="m-${iso}" placeholder="Min" style="width:50px;">
                        <button onclick="add('${iso}')" style="background:var(--p);color:white;border:none;border-radius:6px;padding:10px 15px;font-weight:bold;cursor:pointer;">OK</button>
                    </div>
                </div>`;
            grid.appendChild(d);
            f.setDate(f.getDate()+1);
        }
        load(); filtrarSemana(document.getElementById('btn-default'));
    }

    async function load() {
        const res = await fetch(`${URL}?name=eq.${currentUser}`, { headers });
        tareasCargadas = await res.json();
        document.querySelectorAll('.task-list').forEach(el => el.innerHTML = "");
        document.querySelectorAll('.day-total').forEach(el => el.innerText = "0 min");
        let sums = {};
        
        tareasCargadas.sort((a,b)=> (a.task_time || "99:99").localeCompare(b.task_time || "99:99")).forEach(t => {
            sums[t.task_date] = (sums[t.task_date] || 0) + (t.duration_minutes || 0);
            const cont = document.getElementById(`l-${t.task_date}`);
            if(cont) {
                const color = `hsl(${Math.abs(t.title.charCodeAt(0)*60)%360},70%,90%)`;
                cont.innerHTML += `
                    <div class="task-item" style="background:${color}">
                        ${t.task_time ? `<span class="task-time-label">‚è∞ ${t.task_time}</span>` : ''}
                        <span style="flex-grow:1; font-weight:500;">${t.title}</span>
                        <input type="number" value="${t.duration_minutes||0}" class="edit-time" onchange="upd(${t.id},this.value)">
                        <button onclick="del(${t.id})" style="border:none;background:none;color:red;font-weight:bold;margin-left:5px;cursor:pointer;">√ó</button>
                    </div>`;
            }
        });
        for(let iso in sums) { const el = document.getElementById(`t-${iso}`); if(el) el.innerText = `${sums[iso]} min`; }
    }

    async function add(iso) {
        const title = document.getElementById(`i-${iso}`).value.trim();
        const time = document.getElementById(`h-${iso}`).value;
        const min = document.getElementById(`m-${iso}`).value || 0;
        if(!title) return;
        await fetch(URL, { method:'POST', headers, body: JSON.stringify({
            title, task_date:iso, name:currentUser, duration_minutes:parseInt(min), task_time: time
        })});
        document.getElementById(`i-${iso}`).value = ""; 
        document.getElementById(`h-${iso}`).value = "";
        document.getElementById(`m-${iso}`).value = "";
        load();
    }

    async function upd(id, val) {
        await fetch(`${URL}?id=eq.${id}`, { method:'PATCH', headers, body: JSON.stringify({duration_minutes:parseInt(val)||0})});
        load();
    }

    async function del(id) { await fetch(`${URL}?id=eq.${id}`, { method:'DELETE', headers }); load(); }
    async function borrarDia(iso) { if(confirm("¬øBorrar tareas?")) { await fetch(`${URL}?task_date=eq.${iso}&name=eq.${currentUser}`, { method:'DELETE', headers }); load(); } }
    async function borrarTodo() { if(confirm("¬øBORRAR TODO EL A√ëO?")) { await fetch(`${URL}?name=eq.${currentUser}`, { method:'DELETE', headers }); load(); } }

    function checkAlarms() {
        const ahora = new Date();
        const horaActual = ahora.getHours().toString().padStart(2, '0') + ":" + ahora.getMinutes().toString().padStart(2, '0');
        const hoy = ahora.toLocaleDateString('sv-SE');
        const idAlarma = hoy + horaActual;

        if (idAlarma === ultimaAlarma) return;

        tareasCargadas.forEach(t => {
            if(t.task_date === hoy && t.task_time === horaActual) {
                ultimaAlarma = idAlarma;
                
                // Forzar vibraci√≥n y sonido antes del alert
                if (navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 500]);
                beep();

                // Notificaci√≥n de Sistema
                if ("Notification" in window && Notification.permission === "granted") {
                    new Notification("‚è∞ RuViGesTASK", {
                        body: `¬°Hora de: ${t.title}!`,
                        icon: "https://cdn-icons-png.flaticon.com/512/906/906334.png",
                        tag: idAlarma // Evita duplicados
                    });
                }

                // Alerta Visual
                setTimeout(() => {
                    alert(`‚è∞ ALARMA RUVI GESTASK:\n\n${t.title}\nHora: ${t.task_time}`);
                }, 200);
            }
        });
    }

    function setActive(btn) {
        document.querySelectorAll('.nav-buttons button').forEach(b => b.classList.remove('active'));
        if(btn && btn.tagName === "BUTTON") btn.classList.add('active');
        document.getElementById('month-nav').style.display = 'none';
    }

    function filtrarSemana(btn) {
        setActive(btn);
        const h = new Date(); const l = new Date(h);
        l.setDate(h.getDate() + (h.getDay() === 0 ? -6 : 1 - h.getDay())); l.setHours(0,0,0,0);
        const d = new Date(l); d.setDate(l.getDate()+6); d.setHours(23,59,59);
        document.querySelectorAll('.day-card').forEach(c => {
            const f = new Date(c.dataset.date + "T00:00:00");
            c.classList.toggle('hidden', !(f >= l && f <= d));
        });
    }

    function toggleMeses(btn) { setActive(btn); document.getElementById('month-nav').style.display = 'flex'; }
    function filtrarMes(m) { document.querySelectorAll('.day-card').forEach(c => c.classList.toggle('hidden', c.dataset.mes != m)); }
    function filtrarTodo(btn) { setActive(btn); document.querySelectorAll('.day-card').forEach(c => c.classList.remove('hidden')); }

    function exportarPDF() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y = 20;
        doc.setFontSize(18); doc.setTextColor(92, 103, 242);
        doc.text(`RuViGesTASK - REPORTE 2026`, 10, y); y += 10;
        doc.setFontSize(12); doc.setTextColor(30, 41, 59);
        doc.text(`Usuario: ${currentUser.toUpperCase()}`, 10, y); y += 10;
        
        document.querySelectorAll('.day-card:not(.hidden)').forEach(c => {
            const ts = c.querySelectorAll('.task-item');
            if(ts.length) {
                if(y>270){doc.addPage(); y=20;}
                doc.setFont(undefined, 'bold');
                doc.text(`${c.querySelector('b').innerText}:`, 10, y); y += 7;
                doc.setFont(undefined, 'normal');
                ts.forEach(t => { 
                    const h = t.querySelector('.task-time-label')?.innerText.replace('‚è∞ ', '') || "--:--";
                    const titulo = t.querySelector('span').innerText;
                    const mins = t.querySelector('input').value;
                    doc.text(`[${h}] ${titulo} (${mins} min)`, 15, y); 
                    y += 6; 
                });
                y += 4;
            }
        });
        doc.save(`RuViGesTASK_${currentUser}_2026.pdf`);
    }
</script>
</body>
</html>
