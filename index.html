let currentUser = "";
    const headers = { 'apikey': KEY, 'Authorization': `Bearer ${KEY}`, 'Content-Type': 'application/json' };
    const meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

    function login() {
        const val = document.getElementById('user-in').value.trim();
        if(val) {
            currentUser = val.toLowerCase();
            document.getElementById('disp-user').innerText = val.toUpperCase();
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            init();
        }
    }

    function init() {
        const grid = document.getElementById('calendario');
        const mNav = document.getElementById('month-nav');
        grid.innerHTML = ""; mNav.innerHTML = "";
        meses.forEach((m, i) => {
            const btn = document.createElement('button');
            btn.innerText = m; btn.onclick = () => { filtrarMes(i); document.querySelectorAll('.month-selector button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); };
            mNav.appendChild(btn);
        });
        let f = new Date("2026-01-01T00:00:00");
        while(f.getFullYear() === 2026) {
            const iso = f.toLocaleDateString('sv-SE');
            const d = document.createElement('div');
            d.className = 'day-card'; d.dataset.date = iso; d.dataset.mes = f.getMonth();
            d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;">
                <b style="font-size:0.8rem;">${f.toLocaleDateString('es-ES',{weekday:'short',day:'numeric',month:'short'}).toUpperCase()}</b>
                <div style="display:flex;align-items:center;gap:5px;"><span id="t-${iso}" class="day-total">0 min</span>
                <button onclick="borrarDia('${iso}')" style="border:none;background:none;color:red;cursor:pointer;font-size:1rem;">üóëÔ∏è</button></div>
                </div><div id="l-${iso}" style="margin:8px 0;flex-grow:1;"></div>
                <div class="add-area"><input id="i-${iso}" placeholder="Tarea..." style="padding:6px;border-radius:4px;border:1px solid #ddd;font-size:16px;">
                <div style="display:flex;gap:3px;"><input type="number" id="m-${iso}" placeholder="Min" style="width:50px;padding:6px;border-radius:4px;border:1px solid #ddd;font-size:16px;">
                <button onclick="add('${iso}')" style="flex-grow:1;background:var(--p);color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;">OK</button></div></div>`;
            grid.appendChild(d);
            f.setDate(f.getDate()+1);
        }
        load(); filtrarSemana(document.getElementById('btn-default'));
    }

    async function load() {
        const res = await fetch(`${URL}?name=eq.${currentUser}`, { headers });
        const data = await res.json();
        document.querySelectorAll('[id^="l-"]').forEach(el => el.innerHTML = "");
        document.querySelectorAll('.day-total').forEach(el => el.innerText = "0 min");
        let sums = {};
        data.sort((a,b)=>a.id-b.id).forEach(t => {
            sums[t.task_date] = (sums[t.task_date] || 0) + (t.duration_minutes || 0);
            const cont = document.getElementById(`l-${t.task_date}`);
            if(cont) cont.innerHTML += `<div class="task-item" style="background:hsl(${Math.abs(t.title.charCodeAt(0)*50)%360},75%,90%)">
                <span style="flex-grow:1">${t.title}</span>
                <input type="number" value="${t.duration_minutes||0}" class="edit-time" onchange="upd(${t.id},this.value,'${t.task_date}')">
                <button onclick="del(${t.id})" style="border:none;background:none;color:red;cursor:pointer;font-weight:bold;">√ó</button></div>`;
        });
        for(let iso in sums) { const el = document.getElementById(`t-${iso}`); if(el) el.innerText = `${sums[iso]} min`; }
    }

    async function add(iso) {
        const title = document.getElementById(`i-${iso}`).value;
        const min = document.getElementById(`m-${iso}`).value || 0;
        if(!title) return;
        await fetch(URL, { method:'POST', headers, body: JSON.stringify({title, task_date:iso, name:currentUser, duration_minutes:parseInt(min)})});
        document.getElementById(`i-${iso}`).value = ""; document.getElementById(`m-${iso}`).value = "";
        load();
    }

    async function upd(id, val, iso) {
        await fetch(`${URL}?id=eq.${id}`, { method:'PATCH', headers, body: JSON.stringify({duration_minutes:parseInt(val)||0})});
        load();
    }

    async function del(id) { await fetch(`${URL}?id=eq.${id}`, { method:'DELETE', headers }); load(); }
    async function borrarDia(iso) { if(confirm("¬øBorrar d√≠a?")) { await fetch(`${URL}?task_date=eq.${iso}&name=eq.${currentUser}`, { method:'DELETE', headers }); load(); } }
    async function borrarTodo() { if(confirm("¬øBORRAR TODO EL A√ëO?")) { await fetch(`${URL}?name=eq.${currentUser}`, { method:'DELETE', headers }); load(); } }

    function setActive(btn) {
        document.querySelectorAll('.nav-buttons button').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.getElementById('month-nav').style.display = 'none';
    }

    function filtrarSemana(btn) {
        setActive(btn);
        const h = new Date(); const l = new Date(h);
        l.setDate(h.getDate() + (h.getDay() === 0 ? -6 : 1 - h.getDay())); l.setHours(0,0,0,0);
        const d = new Date(l); d.setDate(l.getDate()+6); d.setHours(23,59,59);
        document.querySelectorAll('.day-card').forEach(c => {
            const f = new Date(c.dataset.date + "T00:00:00");
            c.classList.toggle('hidden', !(f >= l && f <= d));
        });
    }

    function toggleMeses(btn) {
        setActive(btn);
        document.getElementById('month-nav').style.display = 'flex';
    }

    function filtrarMes(m) {
        document.querySelectorAll('.day-card').forEach(c => c.classList.toggle('hidden', c.dataset.mes != m));
    }

    function filtrarTodo(btn) {
        setActive(btn);
        document.querySelectorAll('.day-card').forEach(c => c.classList.remove('hidden'));
    }

    function exportarPDF() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y = 20;
        doc.text(`RuViGesTASK - ${currentUser.toUpperCase()}`, 10, y); y += 10;
        document.querySelectorAll('.day-card:not(.hidden)').forEach(c => {
            const ts = c.querySelectorAll('.task-item');
            if(ts.length) {
                if(y>270){doc.addPage(); y=20;}
                doc.text(`${c.querySelector('b').innerText}:`, 10, y); y += 7;
                ts.forEach(t => { doc.text(`- ${t.querySelector('span').innerText} (${t.querySelector('input').value} min)`, 15, y); y += 6; });
                y += 4;
            }
        });
        doc.save("RuViGesTASK_2026.pdf");
    }
</script>
</body>
</html>

